<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Daily Travel Expense Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="manifest.json" />
  <style>
    :root {
      --bg: #ffffff;
      --text: #000000;
      --input-bg: #f0f0f0;

      --table-bg: #ffffff;
    }
    body.dark {
      --bg: #1e1e1e;
      --text: #f0f0f0;
      --input-bg: #333333;
      --table-bg: #2b2b2b;
    }
    body {
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 20px;
    }
    input, button {
      padding: 8px;
      margin: 5px;
      background: var(--input-bg);
      color: var(--text);
      border: 1px solid #ccc;
    }
    #tableContainer {
      max-height: 300px;
      overflow-y: auto;
      margin-top: 20px;
      border: 1px solid #ccc;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 600px;
      background: var(--table-bg);
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
    }
    .summary {
      margin-top: 15px;
      font-weight: bold;
    }
    .no-data {
      text-align: center;
      padding: 20px;
      color: gray;
    }
    .theme-toggle {
      float: right;
      margin-bottom: 10px;
    }
    @media print {
      form, button, .summary, .theme-toggle, #fileInput {
        display: none;
      }
      #tableContainer {
        max-height: none;
        overflow: visible;
      }
    }
  </style>
</head>
<body>
  <h2>
    Daily Travel Expense Tracker
    <button class="theme-toggle" onclick="toggleTheme()">üåì</button>
  </h2>

  <form id="expenseForm">
    <input type="date" id="date" required />
    <input type="text" id="from" placeholder="From" required />
    <input type="text" id="to" placeholder="To" required />
    <input type="text" id="travel" placeholder="Travelling Cost (‚Çπ)" required />
    <input type="text" id="da" placeholder="DA (‚Çπ)" required />
    <input type="text" id="daClaim" placeholder="DA Claim (‚Çπ)" required />
    <button type="submit">Add Entry</button>
    <button type="button" onclick="exportToExcel()">Download Excel</button>
    <button type="button" onclick="newFile()">New File</button>
    <input type="file" id="fileInput" accept=".json" onchange="importFromJSON()" />
    <button type="button" onclick="sendToGoogleSheets()">Send to Google Sheet</button>
    <button type="button" onclick="window.print()">Print</button>
  </form>

  <div id="tableContainer">
    <table id="expenseTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>From ‚ûù To</th>
          <th>Travelling Cost (‚Çπ)</th>
          <th>DA (‚Çπ)</th>
          <th>DA Claim (‚Çπ)</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div id="noData" class="no-data">No data yet</div>
  </div>

  <div class="summary" id="totals">
    Total Travelling Cost: ‚Çπ0 | Total DA: ‚Çπ0 | Total DA Claim: ‚Çπ0
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    const form = document.getElementById('expenseForm');
    const tableBody = document.querySelector('#expenseTable tbody');
    const noDataMsg = document.getElementById('noData');
    const totalsDisplay = document.getElementById('totals');
    let entries = JSON.parse(localStorage.getItem("travelEntries") || "[]");

    function toggleTheme() {
      document.body.classList.toggle("dark");
      localStorage.setItem("theme", document.body.classList.contains("dark") ? "dark" : "light");
    }

    function loadTheme() {
      if (localStorage.getItem("theme") === "dark") {
        document.body.classList.add("dark");
      }
    }

    loadTheme();

    form.addEventListener("submit", function (e) {
      e.preventDefault();
      addEntry();
    });

    function parseValue(input) {
      return input.split("+").reduce((sum, val) => sum + parseFloat(val.trim() || 0), 0);
    }

    function addEntry(entry = null) {
      const date = entry ? entry[0] : document.getElementById("date").value;
      const from = entry ? entry[1] : document.getElementById("from").value;
      const to = entry ? entry[2] : document.getElementById("to").value;
      const travelRaw = entry ? entry[6] : document.getElementById("travel").value;
      const daRaw = entry ? entry[7] : document.getElementById("da").value;
      const daClaimRaw = entry ? entry[8] : document.getElementById("daClaim").value;

      const travel = parseValue(travelRaw);
      const da = parseValue(daRaw);
      const daClaim = parseValue(daClaimRaw);

      if (!date || !from || !to || isNaN(travel) || isNaN(da) || isNaN(daClaim)) return;

      entries.push([date, from, to, travel, da, daClaim, travelRaw, daRaw, daClaimRaw]);
      saveAndRender();
      form.reset();
    }

    function renderTable() {
      tableBody.innerHTML = "";
      if (entries.length === 0) {
        noDataMsg.style.display = "block";
        return;
      }
      noDataMsg.style.display = "none";

      const grouped = {};
      entries.forEach((e, i) => {
        const key = `${e[0]}-${e[1]}-${e[2]}`;
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push({ row: e, index: i });
      });

      for (const key in grouped) {
        let totalTravel = 0, totalDA = 0, totalDAClaim = 0;
        grouped[key].forEach(({ row, index }) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${row[0]}</td>
            <td>${row[1]} ‚ûù ${row[2]}</td>
            <td>${row[6]} = ${row[3].toFixed(2)}</td>
            <td>${row[7]} = ${row[4].toFixed(2)}</td>
            <td>${row[8]} = ${row[5].toFixed(2)}</td>
            <td>
              <button onclick="editRow(${index})">Edit</button>
              <button onclick="deleteRow(${index})">Delete</button>
            </td>`;
          tableBody.appendChild(tr);
          totalTravel += row[3];
          totalDA += row[4];
          totalDAClaim += row[5];
        });

        const sumRow = document.createElement("tr");
        sumRow.style.fontWeight = "bold";
        sumRow.innerHTML = `
          <td colspan="2">Subtotal</td>
          <td>‚Çπ${totalTravel.toFixed(2)}</td>
          <td>‚Çπ${totalDA.toFixed(2)}</td>
          <td>‚Çπ${totalDAClaim.toFixed(2)}</td>
          <td></td>`;
        tableBody.appendChild(sumRow);
      }

      updateTotals();
    }

    function editRow(index) {
      const row = entries[index];
      document.getElementById("date").value = row[0];
      document.getElementById("from").value = row[1];
      document.getElementById("to").value = row[2];
      document.getElementById("travel").value = row[6];
      document.getElementById("da").value = row[7];
      document.getElementById("daClaim").value = row[8];
      entries.splice(index, 1);
      saveAndRender();
    }

    function deleteRow(index) {
      if (confirm("Are you sure you want to delete this entry?")) {
        entries.splice(index, 1);
        saveAndRender();
      }
    }

    function updateTotals() {
      const totalTravel = entries.reduce((sum, row) => sum + row[3], 0);
      const totalDA = entries.reduce((sum, row) => sum + row[4], 0);
      const totalDAClaim = entries.reduce((sum, row) => sum + row[5], 0);
      totalsDisplay.innerText = `Total Travelling Cost: ‚Çπ${totalTravel.toFixed(2)} | Total DA: ‚Çπ${totalDA.toFixed(2)} | Total DA Claim: ‚Çπ${totalDAClaim.toFixed(2)}`;
    }

    function saveAndRender() {
      localStorage.setItem("travelEntries", JSON.stringify(entries));
      renderTable();
    }

    function newFile() {
      if (confirm("This will clear all current entries. Proceed?")) {
        entries = [];
        localStorage.removeItem("travelEntries");
        saveAndRender();
      }
    }

    function exportToExcel() {
      const headers = ["Date", "From", "To", "Travelling Cost", "DA", "DA Claim", "Travelling Raw", "DA Raw", "DA Claim Raw"];
      const ws = XLSX.utils.aoa_to_sheet([headers, ...entries]);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Expenses");
      XLSX.writeFile(wb, "TravelExpenses.xlsx");
    }

    function importFromJSON() {
      const file = document.getElementById("fileInput").files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const importedData = JSON.parse(e.target.result);
          if (Array.isArray(importedData)) {
            entries = importedData;
            saveAndRender();
          } else {
            alert("Invalid file format.");
          }
        } catch (err) {
          alert("Error reading file.");
        }
      };
      reader.readAsText(file);
    }

    function sendToGoogleSheets() {
      const sheetURL = "YOUR_GOOGLE_APPS_SCRIPT_WEBAPP_URL";
      fetch(sheetURL, {
        method: "POST",
        body: JSON.stringify(entries),
        headers: { "Content-Type": "application/json" }
      })
        .then((res) => res.text())
        .then((msg) => alert("Data sent to Google Sheet successfully!"))
        .catch((err) => alert("Failed to send: " + err.message));
    }

    // Initial load
    saveAndRender();
  </script>
  
</body>
</html>
